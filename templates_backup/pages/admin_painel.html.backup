{% extends 'base.html' %}
{% load static %}

{% block title %}Administra√ß√£o{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i data-lucide="settings"></i>
        Painel Administrativo
    </h1>
    <p class="page-subtitle">Gerencie oficiais, miss√µes, designa√ß√µes e usu√°rios</p>
</div>

<!-- Abas -->
<div class="tabs">
    <button class="tab {% if aba_ativa == 'oficiais' %}active{% endif %}" 
            data-tipo="oficiais"
            hx-get="{% url 'htmx_oficiais_lista' %}" 
            hx-target="#tab-content"
            onclick="setActiveTab(this, 'oficiais')">
        <i data-lucide="users"></i> Oficiais
    </button>
    <button class="tab {% if aba_ativa == 'missoes' %}active{% endif %}"
            data-tipo="missoes"
            hx-get="{% url 'htmx_missoes_lista' %}"
            hx-target="#tab-content"
            onclick="setActiveTab(this, 'missoes')">
        <i data-lucide="folder-kanban"></i> Miss√µes
    </button>
    <button class="tab {% if aba_ativa == 'designacoes' %}active{% endif %}"
            data-tipo="designacoes"
            hx-get="{% url 'htmx_designacoes_lista' %}"
            hx-target="#tab-content"
            onclick="setActiveTab(this, 'designacoes')">
        <i data-lucide="link"></i> Designa√ß√µes
    </button>
    <button class="tab {% if aba_ativa == 'unidades' %}active{% endif %}"
            data-tipo="unidades"
            hx-get="{% url 'htmx_unidades_lista' %}"
            hx-target="#tab-content"
            onclick="setActiveTab(this, 'unidades')">
        <i data-lucide="building"></i> Unidades
    </button>
    <button class="tab {% if aba_ativa == 'usuarios' %}active{% endif %}"
            data-tipo="usuarios"
            hx-get="{% url 'htmx_usuarios_lista' %}"
            hx-target="#tab-content"
            onclick="setActiveTab(this, 'usuarios')">
        <i data-lucide="user-cog"></i> Usu√°rios
    </button>
    <button class="tab"
            data-tipo="solicitacoes"
            hx-get="{% url 'htmx_solicitacoes_lista' %}"
            hx-target="#tab-content"
            onclick="setActiveTab(this, 'solicitacoes')">
        <i data-lucide="inbox"></i> Solicita√ß√µes
    </button>
</div>

<!-- A√ß√µes Gerais -->
<div class="flex justify-between items-center mb-4">
    <div class="flex gap-1">
        <!-- Formul√°rio de Importa√ß√£o -->
        <form id="form-importar" method="post" enctype="multipart/form-data" style="display: inline-flex; gap: 0.5rem;">
            {% csrf_token %}
            <label class="btn btn-secondary btn-sm" style="cursor: pointer;">
                <i data-lucide="upload"></i>
                Selecionar Excel
                <input type="file" name="arquivo" accept=".xlsx,.xls" style="display:none;" id="importar-arquivo" onchange="mostrarNomeArquivo(this)">
            </label>
            <span id="nome-arquivo" style="font-size: 0.85rem; color: #666; align-self: center;"></span>
            <button type="submit" class="btn btn-sm btn-primary" id="btn-importar" style="display: none;">
                <i data-lucide="upload-cloud"></i>
                Importar
            </button>
        </form>
        
        <a href="#" class="btn btn-sm btn-success" id="btn-exportar" onclick="exportarDados()">
            <i data-lucide="download"></i>
            Exportar Excel
        </a>
    </div>
    
    <div class="flex gap-1">
        <span class="badge badge-info" id="badge-tipo" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
            üìÅ Oficiais
        </span>
    </div>
</div>

<!-- Conte√∫do da Aba -->
<div class="card">
    <div class="card-body">
        <div id="tab-content" hx-get="{% url 'htmx_oficiais_lista' %}" hx-trigger="load">
            <p class="text-gray text-center">Carregando...</p>
        </div>
    </div>
</div>

<!-- Legenda de Importa√ß√£o -->
<div class="card mt-4">
    <div class="card-header">
        <h3 class="card-title">
            <i data-lucide="info"></i>
            Instru√ß√µes de Importa√ß√£o
        </h3>
    </div>
    <div class="card-body">
        <p style="margin-bottom: 1rem;">
            <strong>Ordem recomendada de importa√ß√£o:</strong>
        </p>
        <ol style="margin-left: 1.5rem; color: #555;">
            <li><strong>Unidades</strong> - Cadastre primeiro as OBMs</li>
            <li><strong>Oficiais</strong> - Cadastre os oficiais (usu√°rios s√£o criados automaticamente)</li>
            <li><strong>Miss√µes</strong> - Cadastre as miss√µes/opera√ß√µes</li>
            <li><strong>Designa√ß√µes</strong> - Vincule oficiais √†s miss√µes (use o ID da miss√£o e RG do oficial)</li>
            <li><strong>Usu√°rios</strong> - Apenas se precisar criar usu√°rios adicionais ou alterar perfis</li>
        </ol>
        <p style="margin-top: 1rem; color: #888; font-size: 0.9rem;">
            üí° <strong>Dica:</strong> Baixe a planilha modelo com todas as abas e valores v√°lidos.
            <a href="{% url 'exportar_excel' 'modelo' %}" style="color: #8b0000;">Clique aqui para baixar o modelo</a>.
        </p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let tipoAtual = 'oficiais';

function setActiveTab(clickedTab, tipo) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    clickedTab.classList.add('active');
    tipoAtual = tipo;
    
    // Atualizar badge
    const nomes = {
        'oficiais': 'üìÅ Oficiais',
        'missoes': 'üìÅ Miss√µes',
        'designacoes': 'üìÅ Designa√ß√µes',
        'unidades': 'üìÅ Unidades',
        'usuarios': 'üìÅ Usu√°rios',
        'solicitacoes': 'üìÅ Solicita√ß√µes'
    };
    document.getElementById('badge-tipo').textContent = nomes[tipo] || tipo;
    
    // Atualizar action do formul√°rio
    document.getElementById('form-importar').action = '/importar/' + tipo + '/';
    
    // Atualizar link de exporta√ß√£o
    document.getElementById('btn-exportar').href = '/exportar/excel/' + tipo + '/';
    
    // Limpar arquivo selecionado
    document.getElementById('importar-arquivo').value = '';
    document.getElementById('nome-arquivo').textContent = '';
    document.getElementById('btn-importar').style.display = 'none';
}

function mostrarNomeArquivo(input) {
    if (input.files.length > 0) {
        document.getElementById('nome-arquivo').textContent = input.files[0].name;
        document.getElementById('btn-importar').style.display = 'inline-flex';
    }
}

function exportarDados() {
    window.location.href = '/exportar/excel/' + tipoAtual + '/';
}

// Inicializar
document.getElementById('form-importar').action = '/importar/oficiais/';
</script>
{% endblock %}