{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}SIGEM{% endblock %} | Sistema de Gestão de Missões</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Oswald:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- CSS Principal -->
    <link rel="stylesheet" href="{% static 'css/sigem.css' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body class="{% block body_class %}{% endblock %}">
    
    {% if user.is_authenticated %}
    <!-- ========== NAVBAR ========== -->
    <nav class="navbar">
        <div class="navbar-container">
            <!-- Logo e Título -->
            <a href="{% url 'redirecionar_por_perfil' %}" class="navbar-brand">
                <img src="{% static 'img/brasao_cbmgo.png' %}" alt="Brasão CBMGO" class="navbar-logo">
                <div class="navbar-title">
                    <span class="navbar-title-main">SIGEM</span>
                    <span class="navbar-title-sub">Sistema de Gestão de Missões</span>
                </div>
            </a>
            
            <!-- Botão Menu Mobile -->
            <button class="navbar-toggle" id="navbarToggle" aria-label="Abrir menu">
                <span class="navbar-toggle-icon"></span>
            </button>
            
            <!-- Menu Principal -->
            <div class="navbar-menu" id="navbarMenu">
                {% if user.pode_ver_dashboard %}
                <a href="{% url 'dashboard' %}" class="navbar-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Visão Geral</span>
                </a>
                {% endif %}
                
                {% if user.pode_ver_comparar %}
                <a href="{% url 'comparar_oficiais' %}" class="navbar-link {% if request.resolver_match.url_name == 'comparar_oficiais' %}active{% endif %}">
                    <i data-lucide="users"></i>
                    <span>Comparar Oficiais</span>
                </a>
                {% endif %}
                
                {% if user.pode_ver_missoes %}
                <a href="{% url 'missoes_dashboard' %}" class="navbar-link {% if request.resolver_match.url_name == 'missoes_dashboard' %}active{% endif %}">
                    <i data-lucide="folder-kanban"></i>
                    <span>Missões</span>
                </a>
                {% endif %}
                
                {% if user.pode_ver_painel %}
                <a href="{% url 'consultar_oficial' %}" class="navbar-link {% if request.resolver_match.url_name == 'consultar_oficial' or request.resolver_match.url_name == 'consultar_oficial_id' or request.resolver_match.url_name == 'painel_oficial' %}active{% endif %}">
                    <i data-lucide="user-circle"></i>
                    <span>{% if user.role in 'admin,comando_geral,comandante' %}Consultar Oficial{% else %}Meu Painel{% endif %}</span>
                </a>
                {% endif %}
                
                {% if user.pode_ver_admin %}
                <a href="{% url 'admin_painel' %}" class="navbar-link {% if request.resolver_match.url_name == 'admin_painel' %}active{% endif %}">
                    <i data-lucide="settings"></i>
                    <span>Administração</span>
                </a>
                {% endif %}
                
                <!-- Links mobile only -->
                <div class="navbar-mobile-extra">
                    <div class="navbar-mobile-user">
                        <img src="{{ user.foto_url }}" alt="Foto" class="navbar-mobile-avatar">
                        <div>
                            <strong>{% if user.oficial %}{{ user.oficial.posto }} {{ user.oficial.nome_guerra|default:user.oficial.nome }}{% else %}{{ user.cpf }}{% endif %}</strong>
                            <small>{{ user.get_role_display }}</small>
                        </div>
                    </div>
                    <a href="{% url 'logout' %}" class="navbar-link navbar-link-logout">
                        <i data-lucide="log-out"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </div>
            
            <!-- Perfil do Usuário (Desktop) -->
            <div class="navbar-user">
                <div class="navbar-user-info">
                    <span class="navbar-user-name">
                        {% if user.oficial %}
                            {{ user.oficial.posto }} {{ user.oficial.nome_guerra|default:user.oficial.nome }}
                        {% else %}
                            {{ user.cpf }}
                        {% endif %}
                    </span>
                    <span class="navbar-user-role">{{ user.get_role_display }}</span>
                </div>
                <div class="navbar-avatar-container">
                    <img src="{{ user.foto_url }}" alt="Foto" class="navbar-avatar" id="userAvatar">
                    
                    <!-- Dropdown -->
                    <div class="navbar-dropdown" id="userDropdown">
                        <div class="navbar-dropdown-header">
                            <img src="{{ user.foto_url }}" alt="Foto" class="navbar-dropdown-avatar">
                            <div>
                                <strong>{% if user.oficial %}{{ user.oficial }}{% else %}{{ user.cpf }}{% endif %}</strong>
                                <small>{{ user.get_role_display }}</small>
                            </div>
                        </div>
                        <div class="navbar-dropdown-divider"></div>
                        <a href="{% url 'consultar_oficial' %}" class="navbar-dropdown-item">
                            <i data-lucide="user"></i>
                            Meu Painel
                        </a>
                        <a href="{% url 'logout' %}" class="navbar-dropdown-item navbar-dropdown-logout">
                            <i data-lucide="log-out"></i>
                            Sair
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    {% endif %}
    
    <!-- ========== MENSAGENS ========== -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}" role="alert">
            <i data-lucide="{% if message.tags == 'success' %}check-circle{% elif message.tags == 'danger' %}alert-circle{% elif message.tags == 'warning' %}alert-triangle{% else %}info{% endif %}"></i>
            <span>{{ message }}</span>
            <button type="button" class="message-close" onclick="this.parentElement.remove()">
                <i data-lucide="x"></i>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- ========== CONTEÚDO PRINCIPAL ========== -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>
    
    <!-- ========== FOOTER ========== -->
    {% if user.is_authenticated %}
    <footer class="footer">
        <p>&copy; 2026 SIGEM - CBMGO - Criado por 1º Ten QOC 04119 Heitor Braga de Paula</p>
    </footer>
    {% endif %}
    
    <!-- Scripts -->
    <script>
        // Inicializar ícones Lucide
        lucide.createIcons();
        
        // Menu Mobile Toggle
        const navbarToggle = document.getElementById('navbarToggle');
        const navbarMenu = document.getElementById('navbarMenu');
        
        if (navbarToggle && navbarMenu) {
            navbarToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                navbarToggle.classList.toggle('active');
                navbarMenu.classList.toggle('show');
            });
            
            // Fechar menu ao clicar fora
            document.addEventListener('click', (e) => {
                if (!navbarMenu.contains(e.target) && !navbarToggle.contains(e.target)) {
                    navbarToggle.classList.remove('active');
                    navbarMenu.classList.remove('show');
                }
            });
            
            // Fechar menu ao clicar em um link
            navbarMenu.querySelectorAll('.navbar-link').forEach(link => {
                link.addEventListener('click', () => {
                    navbarToggle.classList.remove('active');
                    navbarMenu.classList.remove('show');
                });
            });
        }
        
        // Dropdown do usuário (Desktop)
        const avatar = document.getElementById('userAvatar');
        const dropdown = document.getElementById('userDropdown');
        
        if (avatar && dropdown) {
            avatar.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });
            
            document.addEventListener('click', () => {
                dropdown.classList.remove('show');
            });
        }
        
        // Auto-hide messages
        setTimeout(() => {
            document.querySelectorAll('.message').forEach(msg => {
                msg.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => msg.remove(), 300);
            });
        }, 5000);
        
        // HTMX - Reinicializar ícones após swap
        document.body.addEventListener('htmx:afterSwap', () => {
            lucide.createIcons();
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
