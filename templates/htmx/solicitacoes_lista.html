<!-- 
============================================================
Template: htmx/solicitacoes_lista.html
Lista de solicitações para avaliação (Admin/BM3)
============================================================
-->

<!-- CSRF Token para requisições -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<!-- Cabeçalho com contadores -->
<div class="solicitacoes-header">
    <div class="solicitacoes-tabs">
        <button class="sol-tab {% if filtros.tipo_solicitacao == 'todas' or not filtros.tipo_solicitacao %}active{% endif %}" 
                hx-get="{% url 'htmx_solicitacoes_lista' %}?tipo_solicitacao=todas&status={{ filtros.status }}&busca={{ filtros.busca }}"
                hx-target="#tab-content">
            Todas
            <span class="badge">{{ pendentes_missao|add:pendentes_designacao }}</span>
        </button>
        <button class="sol-tab {% if filtros.tipo_solicitacao == 'missao' %}active{% endif %}"
                hx-get="{% url 'htmx_solicitacoes_lista' %}?tipo_solicitacao=missao&status={{ filtros.status }}&busca={{ filtros.busca }}"
                hx-target="#tab-content">
            <i data-lucide="folder-plus" style="width:14px;height:14px;"></i>
            Missões
            <span class="badge badge-{% if pendentes_missao > 0 %}warning{% else %}info{% endif %}">{{ pendentes_missao }}</span>
        </button>
        <button class="sol-tab {% if filtros.tipo_solicitacao == 'designacao' %}active{% endif %}"
                hx-get="{% url 'htmx_solicitacoes_lista' %}?tipo_solicitacao=designacao&status={{ filtros.status }}&busca={{ filtros.busca }}"
                hx-target="#tab-content">
            <i data-lucide="user-plus" style="width:14px;height:14px;"></i>
            Designações
            <span class="badge badge-{% if pendentes_designacao > 0 %}warning{% else %}info{% endif %}">{{ pendentes_designacao }}</span>
        </button>
    </div>
    
    <!-- Filtros -->
    <div class="solicitacoes-filtros">
        <input type="text" 
               class="form-input" 
               placeholder="Buscar..." 
               value="{{ filtros.busca }}"
               hx-get="{% url 'htmx_solicitacoes_lista' %}?tipo_solicitacao={{ filtros.tipo_solicitacao }}&status={{ filtros.status }}"
               hx-trigger="keyup changed delay:300ms"
               hx-target="#tab-content"
               name="busca"
               style="max-width: 200px;">
        
        <select class="form-select" 
                hx-get="{% url 'htmx_solicitacoes_lista' %}?tipo_solicitacao={{ filtros.tipo_solicitacao }}&busca={{ filtros.busca }}"
                hx-trigger="change"
                hx-target="#tab-content"
                name="status"
                style="max-width: 150px;">
            <option value="">Todos os status</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}" {% if filtros.status == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Área de Feedback -->
<div id="feedback-area"></div>

<style>
.solicitacoes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.solicitacoes-tabs {
    display: flex;
    gap: 0.5rem;
}

.sol-tab {
    padding: 0.5rem 1rem;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    transition: all 0.2s;
}

.sol-tab:hover {
    background: #f9fafb;
}

.sol-tab.active {
    background: #8b0000;
    color: white;
    border-color: #8b0000;
}

.sol-tab.active .badge {
    background: white;
    color: #8b0000;
}

.sol-tab .badge {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
}

.solicitacoes-filtros {
    display: flex;
    gap: 0.5rem;
}

@media (max-width: 768px) {
    .solicitacoes-header {
        flex-direction: column;
        align-items: stretch;
    }
    .solicitacoes-tabs {
        overflow-x: auto;
    }
    .solicitacoes-filtros {
        flex-direction: column;
    }
    .solicitacoes-filtros input,
    .solicitacoes-filtros select {
        max-width: 100% !important;
    }
}

.mb-3 {
    margin-bottom: 1rem;
}

.btn-group-vertical {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.btn-group-horizontal {
    display: flex;
    gap: 0.25rem;
}

.avaliar-designacao-form {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.form-select-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: #6b7280;
}

.empty-state h3 {
    margin-top: 1rem;
    color: #374151;
}

.oficial-mini-foto {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.oficial-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin: 0.75rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.alert-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
}

.alert-danger {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

.alert-info {
    background: #dbeafe;
    color: #1e40af;
    border: 1px solid #93c5fd;
}

.alert i {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}

/* Modal de Edição */
.modal-editar {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-editar.show {
    display: flex;
}

.modal-editar-content {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}

.modal-editar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.modal-editar-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: #1f2937;
}

.modal-editar-body {
    padding: 1.5rem;
}

.btn-icon {
    padding: 0.25rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #6b7280;
    border-radius: 4px;
}

.btn-icon:hover {
    background: #f3f4f6;
}
</style>

<!-- Solicitações de Missão -->
{% if solicitacoes_missao %}
<div class="card mb-3">
    <div class="card-header" style="background: #fef2f2;">
        <h3 class="card-title" style="font-size: 0.95rem;">
            <i data-lucide="folder-plus"></i>
            Solicitações de Missão
        </h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Solicitante</th>
                    <th>Missão</th>
                    <th>Tipo/Local</th>
                    <th>Período</th>
                    <th>Data Solicitação</th>
                    <th>Status</th>
                    <th style="width: 180px;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for s in solicitacoes_missao %}
                <tr id="sol-missao-{{ s.id }}">
                    <td>
                        <div class="oficial-cell">
                            <img src="{{ s.solicitante.foto_url }}" alt="" class="oficial-mini-foto">
                            <div>
                                <strong>{{ s.solicitante.posto }} {{ s.solicitante.nome_guerra }}</strong>
                                <br><small class="text-muted">{{ s.solicitante.obm }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>{{ s.nome_missao }}</strong>
                        <br><small class="text-muted">SEI: {{ s.documento_sei }}</small>
                    </td>
                    <td>
                        {{ s.get_tipo_missao_display }}
                        <br><small class="text-muted">{{ s.get_local_display }}</small>
                    </td>
                    <td>
                        {{ s.data_inicio|date:"d/m/Y" }}
                        {% if s.data_fim %}<br>→ {{ s.data_fim|date:"d/m/Y" }}{% endif %}
                    </td>
                    <td>{{ s.criado_em|date:"d/m/Y H:i" }}</td>
                    <td>
                        <span class="badge badge-{% if s.status == 'APROVADA' %}success{% elif s.status == 'RECUSADA' %}danger{% else %}warning{% endif %}">
                            {{ s.get_status_display }}
                        </span>
                    </td>
                    <td>
                        {% if s.status == 'PENDENTE' %}
                        <div class="btn-group-vertical">
                            <button class="btn btn-sm btn-outline" 
                                    onclick="abrirModalEditarMissao({{ s.id }})"
                                    title="Editar">
                                <i data-lucide="edit"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-success" 
                                    onclick="avaliarSolicitacaoMissao({{ s.id }}, 'aprovar')"
                                    title="Aprovar">
                                <i data-lucide="check"></i> Aprovar
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    onclick="avaliarSolicitacaoMissao({{ s.id }}, 'recusar')"
                                    title="Recusar">
                                <i data-lucide="x"></i> Recusar
                            </button>
                        </div>
                        {% else %}
                        <small class="text-muted">
                            {{ s.avaliado_por.oficial.nome_guerra|default:s.avaliado_por.cpf }}
                            <br>{{ s.data_avaliacao|date:"d/m/Y H:i" }}
                        </small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Solicitações de Designação -->
{% if solicitacoes_designacao %}
<div class="card mb-3">
    <div class="card-header" style="background: #f0fdf4;">
        <h3 class="card-title" style="font-size: 0.95rem;">
            <i data-lucide="user-plus"></i>
            Solicitações de Designação
        </h3>
    </div>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Solicitante</th>
                    <th>Missão</th>
                    <th>Função</th>
                    <th>SEI/BG</th>
                    <th>Data Solicitação</th>
                    <th>Status</th>
                    <th style="width: 200px;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for s in solicitacoes_designacao %}
                <tr id="sol-desig-{{ s.id }}">
                    <td>
                        <div class="oficial-cell">
                            <img src="{{ s.solicitante.foto_url }}" alt="" class="oficial-mini-foto">
                            <div>
                                <strong>{{ s.solicitante.posto }} {{ s.solicitante.nome_guerra }}</strong>
                                <br><small class="text-muted">{{ s.solicitante.obm }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>{{ s.missao.nome|truncatechars:30 }}</strong>
                        <br><small class="text-muted">{{ s.missao.get_tipo_display }}</small>
                    </td>
                    <td>{{ s.funcao_na_missao }}</td>
                    <td>{{ s.documento_sei }}</td>
                    <td>{{ s.criado_em|date:"d/m/Y H:i" }}</td>
                    <td>
                        <span class="badge badge-{% if s.status == 'APROVADA' %}success{% elif s.status == 'RECUSADA' %}danger{% else %}warning{% endif %}">
                            {{ s.get_status_display }}
                        </span>
                        {% if s.complexidade %}
                        <br><small>{{ s.complexidade }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.status == 'PENDENTE' %}
                        <div class="avaliar-designacao-form">
                            <div class="btn-group-horizontal" style="margin-bottom: 0.25rem;">
                                <button class="btn btn-sm btn-outline" 
                                        onclick="abrirModalEditarDesignacao({{ s.id }})"
                                        title="Editar">
                                    <i data-lucide="edit"></i>
                                </button>
                            </div>
                            <select class="form-select form-select-sm" id="complexidade-{{ s.id }}" style="margin-bottom: 0.25rem;">
                                <option value="BAIXA">Baixa</option>
                                <option value="MEDIA" selected>Média</option>
                                <option value="ALTA">Alta</option>
                            </select>
                            <div class="btn-group-horizontal">
                                <button class="btn btn-sm btn-success" 
                                        onclick="avaliarSolicitacaoDesignacao({{ s.id }}, 'aprovar')"
                                        title="Aprovar">
                                    <i data-lucide="check"></i> Aprovar
                                </button>
                                <button class="btn btn-sm btn-danger" 
                                        onclick="avaliarSolicitacaoDesignacao({{ s.id }}, 'recusar')"
                                        title="Recusar">
                                    <i data-lucide="x"></i> Recusar
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <small class="text-muted">
                            {{ s.avaliado_por.oficial.nome_guerra|default:s.avaliado_por.cpf }}
                            <br>{{ s.data_avaliacao|date:"d/m/Y H:i" }}
                        </small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% if not solicitacoes_missao and not solicitacoes_designacao %}
<div class="empty-state">
    <i data-lucide="inbox" style="width:64px;height:64px;color:#d1d5db;"></i>
    <h3>Nenhuma solicitação encontrada</h3>
    <p class="text-muted">Não há solicitações com os filtros selecionados.</p>
</div>
{% endif %}

<!-- Modal de Observação (Aprovar/Recusar) -->
<div id="modal-observacao" class="modal-editar">
    <div class="modal-editar-content" style="max-width: 400px;">
        <div class="modal-editar-header">
            <h3 id="modal-titulo">Avaliar Solicitação</h3>
            <button onclick="fecharModal()" class="btn-icon">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-editar-body">
            <form id="form-avaliar">
                <input type="hidden" id="modal-tipo" value="">
                <input type="hidden" id="modal-id" value="">
                <input type="hidden" id="modal-acao" value="">
                <input type="hidden" id="modal-complexidade" value="">
                
                <div class="form-group">
                    <label class="form-label">Observação (opcional)</label>
                    <textarea class="form-input" id="modal-observacao-text" rows="3" 
                              placeholder="Justificativa ou comentário..."></textarea>
                </div>
                
                <div id="modal-feedback-avaliar"></div>
                
                <div class="form-actions" style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
                    <button type="button" onclick="fecharModal()" class="btn btn-outline">Cancelar</button>
                    <button type="button" onclick="confirmarAvaliacao()" class="btn btn-primary" id="btn-confirmar">
                        Confirmar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div id="modal-editar" class="modal-editar">
    <div class="modal-editar-content">
        <div class="modal-editar-header">
            <h3 id="modal-editar-titulo">Editar Solicitação</h3>
            <button onclick="fecharModalEditar()" class="btn-icon">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="modal-editar-body" id="modal-editar-body">
            <p class="text-center text-muted">Carregando...</p>
        </div>
    </div>
</div>

<script>
// ============================================================
// Funções de Avaliação
// ============================================================
function avaliarSolicitacaoMissao(id, acao) {
    document.getElementById('modal-tipo').value = 'missao';
    document.getElementById('modal-id').value = id;
    document.getElementById('modal-acao').value = acao;
    document.getElementById('modal-titulo').textContent = acao === 'aprovar' ? 'Aprovar Solicitação de Missão' : 'Recusar Solicitação de Missão';
    document.getElementById('btn-confirmar').className = acao === 'aprovar' ? 'btn btn-success' : 'btn btn-danger';
    document.getElementById('btn-confirmar').textContent = acao === 'aprovar' ? 'Aprovar' : 'Recusar';
    document.getElementById('modal-observacao').classList.add('show');
}

function avaliarSolicitacaoDesignacao(id, acao) {
    const complexidade = document.getElementById('complexidade-' + id).value;
    document.getElementById('modal-tipo').value = 'designacao';
    document.getElementById('modal-id').value = id;
    document.getElementById('modal-acao').value = acao;
    document.getElementById('modal-complexidade').value = complexidade;
    document.getElementById('modal-titulo').textContent = acao === 'aprovar' ? 'Aprovar Solicitação de Designação' : 'Recusar Solicitação de Designação';
    document.getElementById('btn-confirmar').className = acao === 'aprovar' ? 'btn btn-success' : 'btn btn-danger';
    document.getElementById('btn-confirmar').textContent = acao === 'aprovar' ? 'Aprovar' : 'Recusar';
    document.getElementById('modal-observacao').classList.add('show');
}

function fecharModal() {
    document.getElementById('modal-observacao').classList.remove('show');
    document.getElementById('modal-observacao-text').value = '';
    document.getElementById('modal-feedback-avaliar').innerHTML = '';
}

function confirmarAvaliacao() {
    const tipo = document.getElementById('modal-tipo').value;
    const id = document.getElementById('modal-id').value;
    const acao = document.getElementById('modal-acao').value;
    const observacao = document.getElementById('modal-observacao-text').value;
    const complexidade = document.getElementById('modal-complexidade').value;
    
    const url = tipo === 'missao' 
        ? '/htmx/solicitacao/missao/' + id + '/avaliar/'
        : '/htmx/solicitacao/designacao/' + id + '/avaliar/';
    
    const formData = new FormData();
    formData.append('acao', acao);
    formData.append('observacao', observacao);
    if (tipo === 'designacao') {
        formData.append('complexidade', complexidade);
    }
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Mostrar loading
    document.getElementById('btn-confirmar').disabled = true;
    document.getElementById('btn-confirmar').textContent = 'Processando...';
    
    fetch(url, {
        method: 'POST',
        body: formData
    }).then(response => response.text())
    .then(html => {
        // Mostrar feedback
        const feedbackArea = document.getElementById('feedback-area');
        const msgClass = acao === 'aprovar' ? 'alert-success' : 'alert-info';
        const msgText = acao === 'aprovar' ? 'Solicitação aprovada com sucesso!' : 'Solicitação recusada.';
        feedbackArea.innerHTML = '<div class="alert ' + msgClass + '"><i data-lucide="check-circle"></i> ' + msgText + '</div>';
        lucide.createIcons();
        
        // Fechar modal e atualizar lista
        fecharModal();
        document.getElementById('tab-content').innerHTML = html;
        lucide.createIcons();
        
        // Remover feedback após 3 segundos
        setTimeout(() => { feedbackArea.innerHTML = ''; }, 3000);
    }).catch(err => {
        document.getElementById('modal-feedback-avaliar').innerHTML = '<div class="alert alert-danger">Erro ao processar: ' + err + '</div>';
        document.getElementById('btn-confirmar').disabled = false;
        document.getElementById('btn-confirmar').textContent = acao === 'aprovar' ? 'Aprovar' : 'Recusar';
    });
}

// ============================================================
// Funções de Edição
// ============================================================
function abrirModalEditarMissao(id) {
    document.getElementById('modal-editar-titulo').textContent = 'Editar Solicitação de Missão';
    document.getElementById('modal-editar-body').innerHTML = '<p class="text-center text-muted">Carregando...</p>';
    document.getElementById('modal-editar').classList.add('show');
    
    fetch('/htmx/solicitacao/missao/' + id + '/dados/')
        .then(response => response.text())
        .then(html => {
            document.getElementById('modal-editar-body').innerHTML = html;
            lucide.createIcons();
        });
}

function abrirModalEditarDesignacao(id) {
    document.getElementById('modal-editar-titulo').textContent = 'Editar Solicitação de Designação';
    document.getElementById('modal-editar-body').innerHTML = '<p class="text-center text-muted">Carregando...</p>';
    document.getElementById('modal-editar').classList.add('show');
    
    fetch('/htmx/solicitacao/designacao/' + id + '/dados/')
        .then(response => response.text())
        .then(html => {
            document.getElementById('modal-editar-body').innerHTML = html;
            lucide.createIcons();
        });
}

function fecharModalEditar() {
    document.getElementById('modal-editar').classList.remove('show');
}

// Fechar modais ao clicar fora
document.getElementById('modal-observacao').addEventListener('click', function(e) {
    if (e.target === this) fecharModal();
});

document.getElementById('modal-editar').addEventListener('click', function(e) {
    if (e.target === this) fecharModalEditar();
});

// Inicializar ícones
lucide.createIcons();
</script>
