{% extends 'base.html' %}
{% load static %}

{% block title %}Missões{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i data-lucide="folder-kanban"></i>
        Painel de Missões
    </h1>
    <p class="page-subtitle">Visualize e gerencie todas as missões do CBMGO</p>
</div>

<!-- Totalizadores por Tipo -->
<div class="dashboard-grid mb-4">
    {% for item in totais_por_tipo %}
    <div class="stat-card {{ item.tipo|lower }}"
         hx-get="{% url 'htmx_missoes_lista' %}?tipo={{ item.tipo }}&status=EM_ANDAMENTO"
         hx-target="#lista-missoes">
        <p class="stat-card-label">{{ item.tipo_display }}</p>
        <p class="stat-card-value">{{ item.total }}</p>
        <i data-lucide="filter" class="stat-card-filter-icon"></i>
    </div>
    {% endfor %}
</div>

<!-- Filtros -->
<div class="filter-bar">
    <div class="form-group">
        <label class="form-label">Tipo</label>
        <select class="form-select" id="filtro-tipo" name="tipo">
            <option value="">Todos os tipos</option>
            {% for value, label in tipo_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">Status</label>
        <select class="form-select" id="filtro-status" name="status">
            <option value="">Todos os status</option>
            {% for value, label in status_choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">Local</label>
        <input type="text" class="form-input" id="filtro-local" name="local" placeholder="Buscar por local...">
    </div>
    
    <div class="form-group">
        <label class="form-label">Data Início</label>
        <input type="date" class="form-input" id="filtro-data-inicio" name="data_inicio">
    </div>
    
    <div class="form-group">
        <label class="form-label">Data Fim</label>
        <input type="date" class="form-input" id="filtro-data-fim" name="data_fim">
    </div>
    
    <button class="btn btn-primary" onclick="filtrarMissoes()">
        <i data-lucide="search"></i>
        Filtrar
    </button>
    
    <button class="btn btn-secondary" onclick="limparFiltros()">
        <i data-lucide="x"></i>
        Limpar
    </button>
</div>

<div class="grid" style="grid-template-columns: 1fr 2fr; gap: 1.5rem;">
    <!-- Lista de Missões -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i data-lucide="list"></i>
                Missões
            </h2>
        </div>
        <div class="card-body" style="max-height: 600px; overflow-y: auto;">
            <div id="lista-missoes" hx-get="{% url 'htmx_missoes_lista' %}" hx-trigger="load">
                <p class="text-gray text-center">Carregando missões...</p>
            </div>
        </div>
    </div>

    <!-- Organograma da Missão Selecionada -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i data-lucide="git-branch"></i>
                Estrutura da Missão
            </h2>
        </div>
        <div class="card-body">
            <div id="organograma-container">
                <p class="text-gray text-center">Selecione uma missão para ver o organograma</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filtrarMissoes() {
    const tipo = document.getElementById('filtro-tipo').value;
    const status = document.getElementById('filtro-status').value;
    const local = document.getElementById('filtro-local').value;
    const dataInicio = document.getElementById('filtro-data-inicio').value;
    const dataFim = document.getElementById('filtro-data-fim').value;
    
    let url = '{% url "htmx_missoes_lista" %}?';
    const params = [];
    
    if (tipo) params.push('tipo=' + encodeURIComponent(tipo));
    if (status) params.push('status=' + encodeURIComponent(status));
    if (local) params.push('local=' + encodeURIComponent(local));
    if (dataInicio) params.push('data_inicio=' + encodeURIComponent(dataInicio));
    if (dataFim) params.push('data_fim=' + encodeURIComponent(dataFim));
    
    url += params.join('&');
    
    htmx.ajax('GET', url, '#lista-missoes');
}

function limparFiltros() {
    document.getElementById('filtro-tipo').value = '';
    document.getElementById('filtro-status').value = '';
    document.getElementById('filtro-local').value = '';
    document.getElementById('filtro-data-inicio').value = '';
    document.getElementById('filtro-data-fim').value = '';
    
    htmx.ajax('GET', '{% url "htmx_missoes_lista" %}', '#lista-missoes');
}
</script>
{% endblock %}