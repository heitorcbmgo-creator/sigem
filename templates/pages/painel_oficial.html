{% extends 'base.html' %}
{% load static %}

{% block title %}Meu Painel{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <i data-lucide="user-circle"></i>
        Meu Painel
    </h1>
    <p class="page-subtitle">Suas missões, designações e solicitações</p>
</div>

<!-- Card do Perfil -->
<div class="card mb-4">
    <div class="card-body">
        <div class="perfil-container">
            <img src="{{ oficial.foto_url }}" alt="Foto" class="officer-photo" style="margin: 0;">
            <div class="perfil-info">
                <h2 class="text-red font-bold" style="font-size: 1.5rem;">
                    {{ oficial.posto }} {{ oficial.nome_guerra|default:oficial.nome }}
                </h2>
                <p class="text-gray">{{ oficial.quadro }} — RG: {{ oficial.rg }}</p>
                <p class="text-gray">{{ oficial.obm|default:"Sem lotação definida" }}</p>
                <p class="text-gray" style="font-style: italic;">{{ oficial.funcao|default:"Função não cadastrada" }}</p>
            </div>
            <div class="perfil-stats">
                <div class="totalizadores-mini">
                    <div class="totalizador-item baixa">
                        <span class="totalizador-valor">{{ oficial.total_baixa }}</span>
                        <span class="totalizador-label">Baixa</span>
                    </div>
                    <div class="totalizador-item media">
                        <span class="totalizador-valor">{{ oficial.total_media }}</span>
                        <span class="totalizador-label">Média</span>
                    </div>
                    <div class="totalizador-item alta">
                        <span class="totalizador-valor">{{ oficial.total_alta }}</span>
                        <span class="totalizador-label">Alta</span>
                    </div>
                </div>
                <p class="text-muted" style="font-size: 0.8rem; margin-top: 0.5rem; text-align: center;">Missões Em Andamento</p>
            </div>
        </div>
    </div>
</div>

<style>
.perfil-container {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
}

.perfil-info {
    flex: 1;
    min-width: 200px;
}

.perfil-stats {
    text-align: right;
}

.totalizadores-mini {
    display: flex;
    gap: 0.75rem;
}

.totalizador-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    min-width: 60px;
}

.totalizador-item.baixa { background: #dcfce7; }
.totalizador-item.media { background: #fef3c7; }
.totalizador-item.alta { background: #fee2e2; }

.totalizador-valor {
    font-size: 1.5rem;
    font-weight: 700;
}

.totalizador-item.baixa .totalizador-valor { color: #166534; }
.totalizador-item.media .totalizador-valor { color: #92400e; }
.totalizador-item.alta .totalizador-valor { color: #991b1b; }

.totalizador-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: #6b7280;
}

@media (max-width: 768px) {
    .perfil-container {
        flex-direction: column;
        text-align: center;
    }
    .perfil-stats {
        text-align: center;
    }
    .totalizadores-mini {
        justify-content: center;
    }
}
</style>

<!-- Minhas Designações -->
<div class="card mb-4">
    <div class="card-header">
        <h2 class="card-title">
            <i data-lucide="briefcase"></i>
            Minhas Designações
        </h2>
        <a href="{% url 'minhas_solicitacoes' %}" class="btn btn-sm btn-outline">
            <i data-lucide="history"></i>
            Ver Histórico de Solicitações
        </a>
    </div>
    <div class="card-body" style="padding: 0;">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Missão</th>
                        <th>Função</th>
                        <th>Complexidade</th>
                        <th>Local</th>
                        <th>Período</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in designacoes %}
                    <tr>
                        <td><strong>{{ d.missao.nome|truncatechars:40 }}</strong></td>
                        <td>{{ d.funcao_na_missao }}</td>
                        <td>
                            <span class="badge badge-{% if d.complexidade == 'ALTA' %}danger{% elif d.complexidade == 'MEDIA' %}warning{% else %}success{% endif %}">
                                {{ d.get_complexidade_display }}
                            </span>
                        </td>
                        <td>{{ d.missao.local|default:"—" }}</td>
                        <td>
                            {% if d.missao.data_inicio %}
                                {{ d.missao.data_inicio|date:"d/m/Y" }}
                                {% if d.missao.data_fim %} → {{ d.missao.data_fim|date:"d/m/Y" }}{% endif %}
                            {% else %}
                                —
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge badge-{% if d.missao.status == 'EM_ANDAMENTO' %}success{% elif d.missao.status == 'PLANEJADA' %}info{% elif d.missao.status == 'CONCLUIDA' %}purple{% else %}danger{% endif %}">
                                {{ d.missao.get_status_display }}
                            </span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center text-gray py-4">Você não possui designações no momento.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Grid de Formulários -->
<div class="solicitacoes-grid">
    <!-- Formulário: Solicitar Inclusão de Missão -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i data-lucide="folder-plus"></i>
                Solicitar Inclusão de Missão
            </h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3" style="font-size: 0.85rem;">
                Solicite a criação de uma nova missão no sistema. A BM/3 irá avaliar e aprovar.
            </p>
            <form hx-post="{% url 'htmx_solicitacao_missao_criar' %}" 
                  hx-target="#feedback-missao" 
                  hx-swap="innerHTML"
                  id="form-solicitar-missao">
                {% csrf_token %}
                
                <div class="form-group">
                    <label class="form-label">Nome da Missão <span class="text-danger">*</span></label>
                    <input type="text" class="form-input" name="nome_missao" required 
                           placeholder="Ex: Operação Carnaval 2025">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo <span class="text-danger">*</span></label>
                        <select class="form-select" name="tipo_missao" required>
                            <option value="">Selecione...</option>
                            {% for value, label in tipo_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status <span class="text-danger">*</span></label>
                        <select class="form-select" name="status_missao" required id="status-missao-select" 
                                onchange="toggleDataFim()">
                            <option value="">Selecione...</option>
                            {% for value, label in status_choices %}
                            <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Local <span class="text-danger">*</span></label>
                    <select class="form-select" name="local" required>
                        <option value="">Selecione...</option>
                        {% for value, label in local_choices %}
                        <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Início <span class="text-danger">*</span></label>
                        <input type="date" class="form-input" name="data_inicio" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Data de Término <span id="label-data-fim-obrig"></span></label>
                        <input type="date" class="form-input" name="data_fim" id="data-fim-input">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nº SEI <span class="text-danger">*</span></label>
                    <input type="text" class="form-input" name="documento_sei" required 
                           placeholder="Ex: 202500012345">
                </div>
                
                <div id="feedback-missao"></div>
                
                <button type="submit" class="btn btn-primary btn-block">
                    <i data-lucide="send"></i>
                    Enviar Solicitação de Missão
                </button>
            </form>
        </div>
    </div>
    
    <!-- Formulário: Solicitar Inclusão de Designação -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <i data-lucide="user-plus"></i>
                Solicitar Inclusão de Designação
            </h2>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3" style="font-size: 0.85rem;">
                Solicite sua designação em uma missão existente. A BM/3 definirá a complexidade.
            </p>
            <form hx-post="{% url 'htmx_solicitacao_designacao_criar' %}" 
                  hx-target="#feedback-designacao" 
                  hx-swap="innerHTML"
                  id="form-solicitar-designacao">
                {% csrf_token %}
                
                <div class="form-group">
                    <label class="form-label">Missão <span class="text-danger">*</span></label>
                    <select class="form-select" name="missao_id" required>
                        <option value="">Selecione uma missão...</option>
                        {% for m in missoes_disponiveis %}
                        <option value="{{ m.id }}">{{ m.nome }} ({{ m.get_status_display }})</option>
                        {% endfor %}
                    </select>
                    {% if not missoes_disponiveis %}
                    <small class="text-muted">Nenhuma missão disponível para designação.</small>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label class="form-label">Função na Missão <span class="text-danger">*</span></label>
                    <input type="text" class="form-input" name="funcao_na_missao" required 
                           placeholder="Ex: Coordenador, Membro, Fiscal">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Complexidade</label>
                    <input type="text" class="form-input" value="Definida pela BM/3" disabled 
                           style="background: #f3f4f6; color: #6b7280;">
                    <small class="text-muted">A complexidade será atribuída pelo avaliador na aprovação.</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nº SEI / BG <span class="text-danger">*</span></label>
                    <input type="text" class="form-input" name="documento_sei" required 
                           placeholder="Ex: SEI 202500012345 ou BG 001/2025">
                </div>
                
                <div id="feedback-designacao"></div>
                
                <button type="submit" class="btn btn-primary btn-block" {% if not missoes_disponiveis %}disabled{% endif %}>
                    <i data-lucide="send"></i>
                    Enviar Solicitação de Designação
                </button>
            </form>
        </div>
    </div>
</div>

<style>
.solicitacoes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

@media (max-width: 860px) {
    .solicitacoes-grid {
        grid-template-columns: 1fr;
    }
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 500px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

.btn-block {
    width: 100%;
    margin-top: 1rem;
}

.mb-3 {
    margin-bottom: 0.75rem;
}

.mb-4 {
    margin-bottom: 1rem;
}

.alert {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin: 0.75rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.alert-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
}

.alert-danger {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
}

.alert-warning {
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fcd34d;
}

.alert i {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
}
</style>

<script>
function toggleDataFim() {
    const statusSelect = document.getElementById('status-missao-select');
    const dataFimInput = document.getElementById('data-fim-input');
    const labelObrig = document.getElementById('label-data-fim-obrig');
    
    if (statusSelect.value === 'CONCLUIDA') {
        dataFimInput.disabled = false;
        dataFimInput.required = true;
        labelObrig.innerHTML = '<span class="text-danger">*</span>';
    } else if (statusSelect.value === 'EM_ANDAMENTO') {
        dataFimInput.disabled = true;
        dataFimInput.required = false;
        dataFimInput.value = '';
        labelObrig.innerHTML = '';
    } else {
        dataFimInput.disabled = false;
        dataFimInput.required = false;
        labelObrig.innerHTML = '';
    }
}

// Limpar formulário após sucesso
document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'feedback-missao' && evt.detail.xhr.response.includes('alert-success')) {
        document.getElementById('form-solicitar-missao').reset();
    }
    if (evt.detail.target.id === 'feedback-designacao' && evt.detail.xhr.response.includes('alert-success')) {
        document.getElementById('form-solicitar-designacao').reset();
    }
    lucide.createIcons();
});
</script>
{% endblock %}
